<!DOCTYPE html>
<html>

<head>
    <style>
        html,
        body {
            padding: 0;
            margin: 0;
        }

        #companies-search {
            width: 20%;
            height: 100vh;
            float: left;
        }

        #search-name {
            margin: 5px;
            padding: 5px;
            font-size: 14px;
        }

        #search-business-group {
            margin: 5px;
            padding: 5px;
        }

        #company-list {
            border: medium;
            font-family: "Noto Sans KR", sans-serif;
        }

        .company-info {
            padding: 8px;
            border-bottom: 1px solid rgb(245, 245, 245);
            font-size: 12px;
            cursor: pointer;
        }

        .company-name {
            font-size: 20px;
            font-weight: bold;
            margin: 6px 0px 6px 0px;
        }

        .company-location {
            font-size: 12px;
            margin: 2px 0px 2px 0px;
        }

        .company-businessGroup {
            font-size: 12px;
            margin: 2px 0px 2px 0px;
        }

        #map {
            width: 80%;
            height: 100vh;
            float: right;
        }
    </style>
</head>

<body>
    <div id="companies-search" style="overflow: auto;">
        <input id="search-name" onkeyup="filterCompanies()" />

        <select id="search-business-group" onmouseup="filterCompanies()">
            <option value="">산업군 선택</option>
        </select>

        <div id="company-list"></div>
    </div>

    <div id="map"></div>

    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=415ac1c77f0dfd57f3ddfbf328cd2e55&libraries=services,clusterer,drawing"></script>
    <script>
        // map 이라는 이름을 가진 element 가져오기
        var mapContainer = document.getElementById('map')
        // 서울~분당 보이는 적절한 시작 위치 설정
        var mapOption = {
            center: new kakao.maps.LatLng(37.5003, 127.084),
            level: 8
        };

        // kakao map api를 이용해 map 생성
        var map = new kakao.maps.Map(mapContainer, mapOption);

        // 지도 타입 컨트롤 생성/추가 [일반/스카이뷰]
        var mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

        // 확대 축소 컨트롤 생성/추가
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        var clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 5
        });

        var data = fetch("data/companies.json")
            .then(function (response) {
                return response.json();
            })
            .then(function (companies) {
                var geocoder = new kakao.maps.services.Geocoder();
                var markers = $(companies).map(function (i, company) {
                    geocoder.addressSearch(company.location, function (position, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            return new kakao.maps.Marker({
                                position: new kakao.maps.LatLng(position[0].y, position[0].x)
                            })
                        }
                    });
                });

                // TODO markers가 안남아있다. jquery 이해도 부족
                clusterer.addMarkers(markers);
            });
    </script>

    <script type="text/javascript"></script>
    <script>
        const companyList = document.getElementById('company-list');
        const tempBusinessGroupList = new Array();

        var companies = fetch("data/companies.json")
            .then(function (response) {
                return response.json();
            })
            .then(function (companies) {
                // 회사 정보를 담을 section 컨트롤 생성 및 하위 div 컨트롤 생성/추가
                for (i = 0; i < companies.length; i++) {
                    var companyInfoSection = document.createElement("section");
                    companyInfoSection.className = 'company-info';
                    companyInfoSection.tabIndex = "0";
                    companyInfoSection.addEventListener("mouseup", drawCompanyOnMap);

                    var companyNameDiv = document.createElement("div");
                    companyNameDiv.className = 'company-name';
                    companyNameDiv.innerHTML = companies[i].name;
                    companyInfoSection.appendChild(companyNameDiv);

                    var companyLocationDiv = document.createElement("div");
                    companyLocationDiv.className = 'company-location';
                    companyLocationDiv.innerHTML = companies[i].location;
                    companyInfoSection.appendChild(companyLocationDiv);

                    var companybusinesGroupDiv = document.createElement("div");
                    companybusinesGroupDiv.className = 'company-business-group';
                    companybusinesGroupDiv.innerHTML = companies[i].businessGroup;
                    companyInfoSection.appendChild(companybusinesGroupDiv);

                    companyList.appendChild(companyInfoSection);

                    tempBusinessGroupList.push(companies[i].businessGroup);
                }

                // 산업군 필터링 컨트롤 Init
                var businessGroupList = document.getElementById('search-business-group');
                const set = new Set(tempBusinessGroupList.sort());

                for (let item of set) {
                    var option = document.createElement('option');
                    option.value = item;
                    option.text = item;

                    businessGroupList.add(option, null);
                }
            });

        // 선택한 회사의 주소를 좌표로 변환 후 지도에 그려주는 함수
        function drawCompanyOnMap() {
            var location = this.querySelector('.company-location').textContent;
            var name = this.querySelector('.company-name').textContent;

            var geocoder = new kakao.maps.services.Geocoder();

            geocoder.addressSearch(location, function (position, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(position[0].y, position[0].x);

                    var marker = new kakao.maps.Marker({
                        map: this.map,
                        position: coords,
                    });

                    var customOverlay = new kakao.maps.CustomOverlay({
                        map: this.map,
                        position: coords,
                        yAnchor: 1
                    });

                    this.map.setLevel(4);

                    map.setCenter(coords);
                }
            });
        }
    </script>

    <script type="text/javascript">
        // 검색 조건 변경시 회사를 필터링
        function filterCompanies() {
            var companyList = document.getElementsByClassName('company-info');
            var searchName = document.getElementById('search-name').value.toUpperCase();
            var selectedBusinessGroup = document.getElementById('search-business-group').value;

            for (var i = 0; i < companyList.length; i++) {
                var name = companyList[i].getElementsByClassName('company-name');
                var businessGroup = companyList[i].getElementsByClassName('company-business-group');

                if (name[0].innerHTML.toUpperCase().indexOf(searchName) > -1) {
                    if (selectedBusinessGroup && businessGroup[0].innerHTML !== selectedBusinessGroup) {
                        companyList[i].style.display = "none";
                    } else {
                        companyList[i].style.display = "block";
                    }
                } else {
                    companyList[i].style.display = "none";
                }
            }
        }
    </script>
</body>

</html>